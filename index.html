<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <title>КП: Рюкзаки (выбор)</title>
  <style>
    :root {
      --bd: rgba(127,127,127,.28);
      --bg: rgba(127,127,127,.06);
      --bg2: rgba(127,127,127,.10);
      --ok: rgba(46, 204, 113, .20);
      --okbd: rgba(46, 204, 113, .45);
    }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    header {
      position: sticky; top: 0; z-index: 5;
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--bd);
      padding: 12px 16px;
    }
    h1 { font-size: 18px; margin: 0 0 10px 0; }
    .controls { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    .controls input[type="search"] {
      padding: 10px 12px; min-width: 240px;
      border-radius: 12px; border: 1px solid var(--bd); background: transparent;
    }
    .controls label {
      display: inline-flex; gap: 8px; align-items: center;
      padding: 8px 10px; border-radius: 12px; border: 1px solid var(--bd);
      user-select: none;
    }
    button {
      padding: 10px 12px; border-radius: 12px;
      border: 1px solid var(--bd); background: transparent; cursor: pointer;
    }
    button.primary { border-color: rgba(127,127,127,.65); font-weight: 650; }
    main { padding: 16px; }
    .meta { opacity: .82; font-size: 13px; margin-top: 8px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 14px; margin-top: 14px; }
    .card {
      border: 1px solid var(--bd); border-radius: 18px; overflow: hidden;
      background: var(--bg); display: flex; flex-direction: column;
    }
    .imgwrap {
      aspect-ratio: 4/3; background: var(--bg2);
      display: grid; place-items: center; position: relative;
    }
    .imgwrap img { width: 100%; height: 100%; object-fit: cover; display: block; }
    .navbtn {
      position: absolute; top: 10px; padding: 8px 10px;
      border-radius: 999px; border: 1px solid var(--bd); background: rgba(0,0,0,.35);
      color: white;
    }
    .navbtn.left { left: 10px; }
    .navbtn.right { right: 10px; }
    .counter {
      position: absolute; bottom: 10px; right: 10px;
      font-size: 12px; padding: 6px 10px; border-radius: 999px;
      border: 1px solid var(--bd); background: rgba(0,0,0,.35); color: white;
    }
    .content { padding: 12px; display: grid; gap: 8px; }
    .title { font-weight: 750; line-height: 1.2; }
    .desc { font-size: 13px; opacity: .9; line-height: 1.38; white-space: pre-line; }
    .row { display: flex; justify-content: space-between; align-items: center; gap: 10px; }
    .price { font-weight: 750; white-space: nowrap; }
    .pill {
      font-size: 12px; padding: 7px 10px; border-radius: 999px;
      border: 1px solid var(--bd);
    }
    .selected { background: var(--ok); border-color: var(--okbd); }
    .toast {
      position: fixed; left: 50%; transform: translateX(-50%); bottom: 14px;
      padding: 10px 12px; border-radius: 12px; border: 1px solid var(--bd);
      background: rgba(0,0,0,.78); color: white; display: none;
      max-width: min(720px, 92vw);
    }
    .toast.show { display: block; }
    details { border: 1px solid var(--bd); border-radius: 12px; padding: 10px 12px; background: var(--bg); }
    summary { cursor: pointer; font-weight: 650; }
    .note { opacity: .78; font-size: 12px; line-height: 1.4; margin-top: 10px; }
    .footer { opacity: .7; font-size: 12px; margin-top: 14px; }
  </style>
</head>
<body>
<header>
  <h1>Рюкзаки: Выбор моделей</h1>

  <div class="controls">
    <input id="q" type="search" placeholder="Поиск по названию и описанию" />
    <label><input id="onlySel" type="checkbox" /> Только выбранные</label>
    <button id="share" class="primary">Поделиться ссылкой</button>
    <button id="export">Экспорт JSON</button>
    <button id="clear" title="Снять все отметки">Сбросить выбор</button>
  </div>

  <div class="meta" id="meta"></div>

  <details>
    <summary>Примечания</summary>
    <div class="note">
      1) Выбор сохраняется в браузере (localStorage), поэтому он остаётся после обновления страницы.<br>
      2) Ссылка «Поделиться» переносит выбор через параметр <code>sel</code> в URL.<br>
      3) Привязка фото к моделям сделана так: Рюкзаки 1–6: по 3 фото (Image_001–Image_018), рюкзак 7: фото Image_019–Image_026. Если у тебя другой порядок, просто поменяй массив <code>images</code> у нужной модели.
    </div>
  </details>
</header>

<main>
  <div class="grid" id="grid"></div>
  <div class="footer">Цены: Указаны без НДС</div>
</main>

<div class="toast" id="toast"></div>

<script>
  const PRODUCTS = [{"id": "bag-001", "name": "Рюкзак, черный, вариант №1", "priceNoVat": 2275, "currency": "RUB", "images": ["images/Image_001.png", "images/Image_002.png", "images/Image_003.png"], "desc": "Практичный городской рюкзак с продуманной компоновкой. Спереди — вместительный карман для мелочей и всего, что должно быть под рукой.\nПо бокам — эластичный отсек, удобно вмещающий бутылку воды.\nВнутри предусмотрен мягкий отдел для ноутбука до 15 дюймов и функциональный органайзер.\nРюкзак оснащён внешним USB-портом для подзарядки гаджетов, а лямки легко регулируются под любой рост."}, {"id": "bag-002", "name": "Рюкзак, черный, вариант №2", "priceNoVat": 3615, "currency": "RUB", "images": ["images/Image_004.png", "images/Image_005.png", "images/Image_006.png"], "desc": "Рюкзак выполнен из мягкой и приятной на ощупь искусственной кожи, идеально подходя для городских перемещений с техникой.\nВ нём предусмотрено всё для удобства: карабин-фиксатор, позволяющий регулировать объём рюкзака в зависимости от загрузки, анатомичные лямки с возможностью подстройки по длине, внутренний отдел для ноутбука, а также внешний ремень для крепления к ручке чемодана."}, {"id": "bag-003", "name": "Рюкзак, черный, вариант №3", "priceNoVat": 2435, "currency": "RUB", "images": ["images/Image_007.png", "images/Image_008.png", "images/Image_009.png"], "desc": "Благодаря дополнительной ручке рюкзак легко превращается в элегантную бизнес-сумку.\nОсновное отделение глубиной 11 см оснащено удобным органайзером и с лёгкостью вмещает как рабочие принадлежности, так и сменную одежду.\nДля комфорта в пути предусмотрены внешний USB-порт для зарядки устройств, ремень для фиксации на чемодане и регулируемые по длине лямки."}, {"id": "bag-004", "name": "Рюкзак, черный, вариант №4", "priceNoVat": 3825, "currency": "RUB", "images": ["images/Image_010.png", "images/Image_011.png", "images/Image_012.png"], "desc": "Водонепроницаемый бизнес-рюкзак оснащён двумя просторными отделениями и фронтальным карманом на молнии.\nВ первом отделении — мягкие отсеки для ноутбука и планшета, во втором — вместительное пространство с органайзером, удобное для одежды и всего необходимого в командировке.\nНа сетчатой спинке скрыт надёжный карман на молнии для документов и ценных мелочей, а также ремень для крепления к ручке чемодана. Сверху расположена мягкая и удобная ручка для переноски, а лямки легко регулируются по длине под любую комплекцию."}, {"id": "bag-005", "name": "Рюкзак, черный, вариант №5", "priceNoVat": 4600, "currency": "RUB", "images": ["images/Image_013.png", "images/Image_014.png", "images/Image_015.png"], "desc": "Практичный бизнес-рюкзак с двумя вместительными отделениями: одно — с карманом для ноутбука до 15,6\", другое — с органайзером.\nМолния на отделении для техники смещена к спинке, усложняя несанкционированный доступ. Спереди — карман на молнии, сзади — потайной карман для документов.\nПо бокам — эластичные сетчатые карманы под бутылки разного диаметра. Дополнительно: ремень для крепления к чемодану, внешний USB-порт, дышащая спинка и регулируемые лямки."}, {"id": "bag-006", "name": "Рюкзак, черный, вариант №6", "priceNoVat": 5650, "currency": "RUB", "images": ["images/Image_016.png", "images/Image_017.png", "images/Image_018.png"], "desc": "Универсальный рюкзак-трансформер легко превращается в деловую сумку.\nВнутри — просторное отделение с ремнями для одежды и карабином для ключей, а также отсек для ноутбука с органайзером.\nСпереди — два кармана на молнии, на лямке — светоотражатель и карман для карт. На спинке\n— потайной карман, дышащая сетка и ремень для крепления к чемодану. Дополнительно: USB-порт и регулируемые лямки."}, {"id": "bag-007", "name": "Рюкзак, черный, вариант №7", "priceNoVat": 3295, "currency": "RUB", "images": ["images/Image_019.png", "images/Image_020.png", "images/Image_021.png", "images/Image_022.png", "images/Image_023.png", "images/Image_024.png", "images/Image_025.png", "images/Image_026.png"], "desc": "Компактный городской рюкзак с расширяемым основным отделением: объём — 10,5 л (до 14 л в развёрнутом виде).\nСпереди — два вместительных кармана, внутри\n— карман для ноутбука на эластичной ленте. На спинке — потайной карман на молнии, дышащая сетчатая поверхность и ремень для крепления к чемодану. Детали из экокожи, лямки регулируются по длине."}];
  const STORAGE_KEY = "kit.bags.selection.v2";

  const imgIndex = new Map(); // productId -> current image index

  function rub(n) {
    try {
      return new Intl.NumberFormat("ru-RU", { style: "currency", currency: "RUB", maximumFractionDigits: 0 }).format(n);
    } catch {
      return `${n} ₽`;
    }
  }

  function toast(msg) {
    const el = document.getElementById("toast");
    el.textContent = msg;
    el.classList.add("show");
    clearTimeout(toast._t);
    toast._t = setTimeout(() => el.classList.remove("show"), 1800);
  }

  function loadSelection() {
    const params = new URLSearchParams(location.search);
    const sel = params.get("sel");
    if (sel) {
      const ids = sel.split(",").map(s => decodeURIComponent(s.trim())).filter(Boolean);
      return new Set(ids);
    }

    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return new Set();
      const ids = JSON.parse(raw);
      if (!Array.isArray(ids)) return new Set();
      return new Set(ids.map(String));
    } catch {
      return new Set();
    }
  }

  function saveSelection(set) {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify([...set]));
    } catch {}
  }

  let selection = loadSelection();

  function productMatches(p, query) {
    if (!query) return true;
    const s = (p.name + " " + (p.desc || "")).toLowerCase();
    return s.includes(query.toLowerCase());
  }

  function shareLink() {
    const ids = [...selection];
    const url = new URL(location.href);
    const params = url.searchParams;
    if (ids.length) {
      params.set("sel", ids.map(encodeURIComponent).join(","));
    } else {
      params.delete("sel");
    }
    url.search = params.toString();

    navigator.clipboard?.writeText(url.toString())
      .then(() => toast("Ссылка скопирована в буфер"))
      .catch(() => {
        prompt("Скопируй ссылку", url.toString());
      });
  }

  function exportJSON() {
    const chosen = PRODUCTS.filter(p => selection.has(p.id));
    const payload = {
      exportedAt: new Date().toISOString(),
      selectedCount: chosen.length,
      selectedIds: [...selection],
      selectedItems: chosen
    };

    const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
    const u = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = u;
    a.download = "selected-backpacks.json";
    document.body.appendChild(a);
    a.click();
    a.remove();

    URL.revokeObjectURL(u);
    toast("Экспортировано в JSON");
  }

  function render() {
    const grid = document.getElementById("grid");
    const q = document.getElementById("q").value.trim();
    const onlySel = document.getElementById("onlySel").checked;

    const items = PRODUCTS
      .filter(p => productMatches(p, q))
      .filter(p => !onlySel || selection.has(p.id));

    document.getElementById("meta").textContent =
      `Всего моделей: ${PRODUCTS.length}. Показано: ${items.length}. Выбрано: ${selection.size}.`;

    grid.innerHTML = "";

    for (const p of items) {
      const card = document.createElement("div");
      card.className = "card";

      const imgwrap = document.createElement("div");
      imgwrap.className = "imgwrap";

      const imgs = Array.isArray(p.images) && p.images.length ? p.images : [];
      const cur = Math.min(imgs.length - 1, Math.max(0, imgIndex.get(p.id) ?? 0));

      const img = document.createElement("img");
      img.loading = "lazy";
      img.alt = p.name || "Рюкзак";
      img.src = imgs[cur] || "";
      img.onerror = () => { imgwrap.textContent = "Нет изображения"; };

      imgwrap.appendChild(img);

      if (imgs.length > 1) {
        const prev = document.createElement("button");
        prev.className = "navbtn left";
        prev.textContent = "←";
        prev.onclick = (e) => {
          e.preventDefault();
          const nextIdx = ((imgIndex.get(p.id) ?? 0) - 1 + imgs.length) % imgs.length;
          imgIndex.set(p.id, nextIdx);
          render();
        };

        const next = document.createElement("button");
        next.className = "navbtn right";
        next.textContent = "→";
        next.onclick = (e) => {
          e.preventDefault();
          const nextIdx = ((imgIndex.get(p.id) ?? 0) + 1) % imgs.length;
          imgIndex.set(p.id, nextIdx);
          render();
        };

        const counter = document.createElement("div");
        counter.className = "counter";
        counter.textContent = `${cur + 1}/${imgs.length}`;

        imgwrap.appendChild(prev);
        imgwrap.appendChild(next);
        imgwrap.appendChild(counter);
      }

      const content = document.createElement("div");
      content.className = "content";

      const title = document.createElement("div");
      title.className = "title";
      title.textContent = p.name;

      const desc = document.createElement("div");
      desc.className = "desc";
      desc.textContent = p.desc || "";

      const row = document.createElement("div");
      row.className = "row";

      const price = document.createElement("div");
      price.className = "price";
      price.textContent = Number.isFinite(p.priceNoVat) ? rub(p.priceNoVat) : "";

      const btn = document.createElement("button");
      const isSel = selection.has(p.id);
      btn.className = "pill" + (isSel ? " selected" : "");
      btn.textContent = isSel ? "Выбрано" : "Выбрать";
      btn.onclick = () => {
        if (selection.has(p.id)) selection.delete(p.id);
        else selection.add(p.id);
        saveSelection(selection);
        render();
      };

      row.appendChild(price);
      row.appendChild(btn);

      content.appendChild(title);
      content.appendChild(desc);
      content.appendChild(row);

      card.appendChild(imgwrap);
      card.appendChild(content);

      grid.appendChild(card);
    }
  }

  document.getElementById("q").addEventListener("input", render);
  document.getElementById("onlySel").addEventListener("change", render);
  document.getElementById("share").addEventListener("click", shareLink);
  document.getElementById("export").addEventListener("click", exportJSON);
  document.getElementById("clear").addEventListener("click", () => {
    selection = new Set();
    saveSelection(selection);
    render();
    toast("Выбор сброшен");
  });

  render();
</script>
</body>
</html>
